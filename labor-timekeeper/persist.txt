# JCW Labor Timekeeper - Session Persistence
# Last updated: February 6, 2026

## PROJECT OVERVIEW
Construction crew time tracking PWA with voice input and payroll export.
- Employee time entry with voice notes (OpenAI Whisper)
- Admin approval workflow (PIN: 7707)
- Weekly and Monthly XLSX payroll exports
- Cloud backup to Google Cloud Storage

## PRODUCTION DEPLOYMENT
- URL: https://labor-timekeeper-dot-jcw-2-android-estimator.uc.r.appspot.com
- Project: jcw-2-android-estimator
- Region: us-central1
- Runtime: nodejs22 on App Engine
- Database: SQLite in /tmp/app.db (ephemeral, restored from Cloud Storage on startup)
- Bucket: gs://jcw-labor-timekeeper

## SECRETS (Google Secret Manager)
- SMTP_USER: nathan@jcwelton.com
- SMTP_PASS: (configured)
- OPENAI_API_KEY: sk-proj-... (configured, version 4)

## DEPLOY COMMANDS
```powershell
$gcloud = "C:\Users\nathan\AppData\Local\Google\Cloud SDK\google-cloud-sdk\bin\gcloud.cmd"
cd c:\Users\nathan\dev\repos\jcw_payroll\labor-timekeeper
& $gcloud app deploy --quiet

# Seed after deploy:
$baseUrl = "https://labor-timekeeper-dot-jcw-2-android-estimator.uc.r.appspot.com"
Invoke-RestMethod -Uri "$baseUrl/api/admin/seed" -Method POST
```

## CURRENT STATE / KNOWN ISSUES
1. Admin PIN gate working (7707)
2. 62 test entries imported for week 2026-01-28, SUBMITTED status
3. Ready for admin approval at patch URL, then monthly report download for 2026-02
4. Employee sheets now query FULL month range (not just first week) - fixed empty sheets bug

## RECENT CHANGES
### Feb 6, 2026 - Payroll Export & Encoding Fixes (patch p-ui0206)
- lib/export/generateMonthly.js: FIXED employee sheets empty bug (was querying only first week, now full month range)
- public/app.html: Fixed UTF-16LE encoding (em dash, pin icon, delete button ‚úï)
- public/admin.html: Fixed UTF-16LE encoding (üìäüìã‚úÖ‚ùåüõ†Ô∏èüå±‚ö†Ô∏è emojis, em dash)
- scripts/import_test_entries.mjs: NEW - imports exact payroll data (62 entries for week 2026-01-28)
- scripts/fix_encoding.mjs: Utility to fix mojibake in UTF-16LE HTML files
- 62 entries imported as SUBMITTED for: Boban Abbate, Doug Kinsey, Sean Matthew, Thomas Brinson, Jason Green, Phil Henderson
- Customers covered: Behrens, Boyle, Gee, Landy, Lucas, Lynn, O'Connor, PTO, Schroeder, Theobald, Walsh, Watkins
- Total hours: 242.75
- Patch URL: https://p-ui0206-dot-labor-timekeeper-dot-jcw-2-android-estimator.uc.r.appspot.com
- Promote command: gcloud app services set-traffic labor-timekeeper --splits p-ui0206=1 --project=jcw-2-android-estimator --quiet

### Feb 6, 2026 - Mobile UI Optimization (earlier in session)
- public/app.html: Voice "Speak it" section now collapsible (collapsed by default)
- public/app.html: Added "Hide Notes" / "Show Notes" toggle button on entries table
- public/styles.css: Added mobile-first CSS (@media ‚â§640px) - larger buttons, full-width stacking

### Previous (not yet verified)
- public/admin.html: Added Select All checkbox, total row in approvals table
- lib/secrets.js: Loads secrets from Google Secret Manager
- Voice recording: Safari/iOS compatibility (webm/mp4/aac/ogg fallbacks)
- server.js: Added admin simulation endpoint `/api/admin/simulate-week`
- public/app.html: Wired `Submit Week` button to backend

## RELEASE 1.1 DRAFT UPGRADES
1. Voice review & edit step for parsed entries (edit customer/hours/date/notes before apply).
2. Limited voice correction commands for the current parsed list (e.g., "change entry 2 customer to Hall").
3. Inline edit for saved entries (customer, hours, notes) + one-tap delete.
4. Voice suggestions from recent/favorite customers to reduce mis-matches.
5. Front-end polish (clearer grouping, status feedback, quick-hour chips).

## KEY FILES
- server.js: Express API server, main entry point
- public/app.html: Employee time entry UI
- public/admin.html: Admin dashboard (PIN protected)
- lib/export/generateMonthly.js: Monthly payroll XLSX (vertical format with dates)
- lib/export/generateWeekly.js: Weekly per-employee XLSX
- lib/storage.js: Cloud Storage backup/restore, reconciliation
- lib/secrets.js: Google Secret Manager integration
- app.yaml: App Engine config

## API ENDPOINTS
- POST /api/time-entries: Submit time entry
- GET /api/approvals?week_start=YYYY-MM-DD: Get pending entries
- POST /api/approve: Approve selected entries {ids: [...]}
- GET /api/export/monthly?month=YYYY-MM: Download monthly XLSX
- GET /api/admin/generate-week?week_start=YYYY-MM-DD: Generate weekly exports
- GET /api/admin/generate-month?month=YYYY-MM: Generate monthly export
- POST /api/admin/seed: Seed database from JSON files
- POST /api/admin/reconcile: Archive and clear month data

## DATA MODEL
- employees (id, name, default_bill_rate)
- customers (id, name, address)
- rate_overrides (employee_id, customer_id, rate)
- time_entries (employee_id, customer_id, work_date, hours, notes, status)
- Status values: PENDING, APPROVED, REJECTED

## TESTING
- Playwright tests: npm test (18 tests)
- Config: playwright.config.cjs
- Tests file: tests/labor-timekeeper.spec.cjs

## TODO / NEXT STEPS
1. Test admin Load button locally
2. Test Weekly and Monthly export buttons
3. Test `Simulate Week` admin feature (use week 2026-01-05, try reset+submit+approve)
4. Verify employee `Submit Week` workflow now submits and updates status
3. Verify date column appears in exported XLSX
4. May need to fix admin.html JavaScript if buttons not working
5. Run UAT tests after fixes

## EMPLOYEE CATEGORIES
- Hourly: Default employees (shown in main payroll section)
- Admin: Chris J, Chris Z (shown in separate Office section, not per-customer)

## NOTES
- /tmp is ephemeral on App Engine - database auto-restores from Cloud Storage
- Backup runs every 5 minutes in production
- Use reconciliation feature to archive months before clearing
