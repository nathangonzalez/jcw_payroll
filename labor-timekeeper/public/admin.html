<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Labor Timekeeper - Admin</title>
  <link rel="stylesheet" href="/styles.css" />
</head>
<body>
  <!-- PIN Gate -->
  <div id="pinGate" class="container" style="margin-top:50px;">
    <div class="card" style="max-width:300px; margin:0 auto; text-align:center;">
      <h2>üîí Admin Access</h2>
      <p class="muted small">Enter PIN to continue</p>
      <input id="pinInput" type="password" inputmode="numeric" maxlength="4" placeholder="****" style="font-size:1.5rem; text-align:center; letter-spacing:8px; padding:12px;" />
      <button id="pinBtn" class="primary" style="margin-top:12px; width:100%;">Unlock</button>
      <p id="pinError" class="small" style="color:#e74c3c; margin-top:8px; display:none;">Incorrect PIN</p>
    </div>
  </div>

  <!-- Admin Content (hidden until PIN verified) -->
  <div id="adminContent" class="container" style="display:none;">
    <div class="row" style="align-items:center; justify-content:space-between;">
      <h1>Admin</h1>
      <a href="/app" class="badge">Employee view</a>
    </div>

    <div class="card" style="margin-top:12px;">
      <h2>Approvals</h2>
      <div class="row">
        <div class="col">
          <label class="small muted">Week start (YYYY-MM-DD)</label>
          <input id="weekStart" placeholder="YYYY-MM-DD" />
        </div>
        <div class="col">
          <label class="small muted">&nbsp;</label>
          <button class="primary" id="loadBtn">Load Submitted</button>
        </div>
      </div>

      <div id="submitted" style="margin-top:12px;"></div>

      <div class="row" style="margin-top:12px;">
        <div class="col"><button id="approveBtn" class="primary">Approve Selected</button></div>
      </div>

      <hr/>

      <h2>üìä Payroll Reports</h2>
      <div class="row">
        <div class="col">
          <label class="small muted">Week Start</label>
          <input id="pipelineWeek" placeholder="YYYY-MM-DD" />
        </div>
        <div class="col">
          <label class="small muted">Month</label>
          <input id="pipelineMonth" placeholder="YYYY-MM" />
        </div>
      </div>
      <div class="row" style="margin-top:12px; gap:8px;">
        <button id="genWeekBtn" class="primary">‚¨áÔ∏è Weekly Report (per Employee)</button>
        <button id="genMonthBtn" class="primary">‚¨áÔ∏è Monthly Breakdown</button>
      </div>
      <div id="pipelineResult" style="margin-top:12px; padding:10px; background:#f8f9fa; border-radius:4px; display:none;">
        <pre id="pipelineOutput" style="margin:0; white-space:pre-wrap; font-size:12px;"></pre>
      </div>

      <hr/>

      <h2>‚úÖ Reconcile Payroll</h2>
      <div class="row">
        <div class="col">
          <label class="small muted">Month to Reconcile</label>
          <input id="closeMonth" placeholder="YYYY-MM" />
        </div>
        <div class="col">
          <label class="small muted">&nbsp;</label>
          <button id="previewReconcileBtn" style="background:#3498db; color:white;">Preview</button>
          <button id="closeMonthBtn" style="background:#e74c3c; color:white;">Reconcile & Clear</button>
        </div>
      </div>
      <p class="muted small">Archives data to cloud storage then clears entries. Only keep 1 month of active data.</p>

      <p class="muted small" id="msg"></p>
    </div>
  </div>
</div>

<script>
const ADMIN_PIN = '7707';
const PIN_KEY = 'labor_timekeeper_admin_auth';

function el(id){ return document.getElementById(id); }

// PIN Gate Logic
function checkPin() {
  const saved = sessionStorage.getItem(PIN_KEY);
  if (saved === 'verified') {
    showAdmin();
    return true;
  }
  return false;
}

function showAdmin() {
  el('pinGate').style.display = 'none';
  el('adminContent').style.display = 'block';
  init();
}

function verifyPin() {
  const pin = el('pinInput').value;
  if (pin === ADMIN_PIN) {
    sessionStorage.setItem(PIN_KEY, 'verified');
    showAdmin();
  } else {
    el('pinError').style.display = 'block';
    el('pinInput').value = '';
    el('pinInput').focus();
  }
}

// Set up PIN handlers
el('pinBtn').onclick = verifyPin;
el('pinInput').onkeydown = (e) => { if (e.key === 'Enter') verifyPin(); };

// Check if already authenticated
if (!checkPin()) {
  el('pinInput').focus();
}

async function api(url, opts){
  const r = await fetch(url, opts);
  const j = await r.json().catch(()=>null);
  if (!r.ok) throw new Error((j && j.error) || 'Request failed');
  return j;
}

let submittedCache=[];

async function init(){
  el('loadBtn').onclick = loadSubmitted;
  el('approveBtn').onclick = approveSelected;

  // Report download buttons
  el('genWeekBtn').onclick = downloadWeekly;
  el('genMonthBtn').onclick = downloadMonthly;
  el('previewReconcileBtn').onclick = previewReconcile;
  el('closeMonthBtn').onclick = closeMonth;

  // Set default values for pipeline inputs
  const now = new Date();
  const ym = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
  el('pipelineMonth').value = ym;
  el('closeMonth').value = ym;

  // default week start: ask server by loading approvals once without week
  const data = await api('/api/approvals?_=' + Date.now());
  el('weekStart').value = data.week_start;
  el('pipelineWeek').value = data.week_start;
  submittedCache = data.submitted;
  renderSubmitted(data.submitted);
}

// Report download functions
async function downloadWeekly() {
  const week_start = el('pipelineWeek').value.trim();
  if (!week_start) { alert('Enter week start date'); return; }
  try {
    showPipelineResult('Generating weekly exports...');
    const result = await api(`/api/admin/generate-week?week_start=${encodeURIComponent(week_start)}`);
    
    if (result.files && result.files.length > 0) {
      const output = [
        `‚úÖ Weekly Export Complete`,
        `Week: ${result.weekStart}`,
        ``,
        `Files Generated (${result.files.length}):`,
        ...result.files.map(f => `  ‚Ä¢ ${f.filename}: ${f.hours}hrs ($${f.amount})`),
        ``,
        `Total: ${result.totals.totalHours} hours, $${result.totals.totalAmount}`,
        ``,
        `Files saved to: ${result.outputDir}`,
      ].join('\n');
      showPipelineResult(output);
    } else {
      showPipelineResult('No approved entries found for this week.');
    }
  } catch (err) {
    showPipelineResult(`‚ùå Error: ${err.message}`);
  }
}

async function downloadMonthly() {
  const month = el('pipelineMonth').value.trim();
  if (!month) { alert('Enter month (YYYY-MM)'); return; }
  // Directly download the file
  window.location.href = `/api/export/monthly?month=${encodeURIComponent(month)}`;
}

async function previewReconcile() {
  const month = el('closeMonth').value.trim();
  if (!month) { alert('Enter month to reconcile'); return; }
  
  try {
    showPipelineResult('Loading preview...');
    const result = await api('/api/admin/reconcile', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ month, confirm: false })
    });
    const output = [
      `üìã Reconciliation Preview for ${month}`,
      ``,
      `Entries to archive: ${result.entries}`,
      `Total Hours: ${result.totalHours}`,
      `Total Billed: $${result.totalBilled}`,
      ``,
      `Click "Reconcile & Clear" to archive and remove this data.`
    ].join('\n');
    showPipelineResult(output);
  } catch (err) {
    showPipelineResult(`‚ùå Error: ${err.message}`);
  }
}

async function closeMonth() {
  const month = el('closeMonth').value.trim();
  if (!month) { alert('Enter month to reconcile'); return; }
  
  const confirmed = confirm(`‚ö†Ô∏è This will archive and clear ALL time entries for ${month}.\n\nData will be saved to cloud storage but removed from active database.\n\nContinue?`);
  if (!confirmed) return;
  
  try {
    showPipelineResult('Archiving and clearing...');
    const result = await api('/api/admin/reconcile', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ month, confirm: true })
    });
    const output = [
      `‚úÖ Payroll Reconciled for ${month}`,
      ``,
      `Archived: ${result.archived} entries`,
      `Total Hours: ${result.summary.totalHours}`,
      `Total Billed: $${result.summary.totalBilled}`,
      ``,
      `Data has been archived and cleared from active database.`
    ].join('\n');
    showPipelineResult(output);
  } catch (err) {
    showPipelineResult(`‚ùå Error: ${err.message}`);
  }
}

function showPipelineResult(text) {
  el('pipelineResult').style.display = 'block';
  el('pipelineOutput').textContent = text;
}

async function loadSubmitted(){
  const week_start = el('weekStart').value.trim();
  const data = await api('/api/approvals?week_start=' + encodeURIComponent(week_start) + '&_=' + Date.now());
  submittedCache = data.submitted;
  renderSubmitted(data.submitted);
}

function renderSubmitted(rows){
  if (!rows.length){
    el('submitted').innerHTML = '<p class="muted">No submitted entries.</p>';
    return;
  }
  const totalHours = rows.reduce((sum, r) => sum + Number(r.hours), 0);
  const html = `
    <table>
      <thead><tr>
        <th><input type="checkbox" id="selectAll" title="Select All" /></th>
        <th>Date</th><th>Employee</th><th>Customer</th><th>Hours</th>
      </tr></thead>
      <tbody>
        ${rows.map(r=>`
          <tr>
            <td><input type="checkbox" class="entry-cb" data-id="${r.id}" /></td>
            <td>${r.work_date}</td>
            <td>${r.employee_name}</td>
            <td>${r.customer_name}</td>
            <td>${Number(r.hours)}</td>
          </tr>
        `).join('')}
      </tbody>
      <tfoot><tr style="font-weight:bold; background:#f0f0f0;">
        <td></td><td colspan="3">Total (${rows.length} entries)</td><td>${totalHours}</td>
      </tr></tfoot>
    </table>
  `;
  el('submitted').innerHTML = html;
  
  // Select All handler
  el('selectAll').onchange = function() {
    document.querySelectorAll('.entry-cb').forEach(cb => cb.checked = this.checked);
  };
  // Update Select All when individual boxes change
  document.querySelectorAll('.entry-cb').forEach(cb => {
    cb.onchange = updateSelectAllState;
  });
}

function updateSelectAllState() {
  const all = document.querySelectorAll('.entry-cb');
  const checked = document.querySelectorAll('.entry-cb:checked');
  const selectAll = el('selectAll');
  if (selectAll) {
    selectAll.checked = all.length > 0 && all.length === checked.length;
    selectAll.indeterminate = checked.length > 0 && checked.length < all.length;
  }
}

async function approveSelected(){
  const ids = [...document.querySelectorAll('.entry-cb:checked')].map(x=>x.getAttribute('data-id'));
  if (!ids.length) { alert('Select at least one.'); return; }
  await api('/api/approve', {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ ids })
  });
  alert(`Approved ${ids.length} entries!`);
  await loadSubmitted();
}

init().catch(e=>{
  console.error(e);
  alert(e.message || 'Failed to load');
});
</script>
</body>
</html>
