<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Labor Timekeeper - Admin</title>
  <link rel="stylesheet" href="/styles.css" />
</head>
<body>
  <div class="container">
    <div class="row" style="align-items:center; justify-content:space-between;">
      <h1>Admin</h1>
      <a href="/app" class="badge">Employee view</a>
    </div>

    <div class="card" style="margin-top:12px;">
      <h2>Approvals</h2>
      <div class="row">
        <div class="col">
          <label class="small muted">Week start (YYYY-MM-DD)</label>
          <input id="weekStart" placeholder="YYYY-MM-DD" />
        </div>
        <div class="col">
          <label class="small muted">&nbsp;</label>
          <button class="primary" id="loadBtn">Load Submitted</button>
        </div>
      </div>

      <div id="submitted" style="margin-top:12px;"></div>

      <div class="row" style="margin-top:12px;">
        <div class="col"><button id="approveBtn" class="primary">Approve Selected</button></div>
        <div class="col"><button id="exportMonthBtn">Export Monthly Summary</button></div>
      </div>

      <hr/>

      <h2>üìä Payroll XLSX Pipeline</h2>
      <div class="row">
        <div class="col">
          <label class="small muted">Week Start</label>
          <input id="pipelineWeek" placeholder="YYYY-MM-DD" />
        </div>
        <div class="col">
          <label class="small muted">Month</label>
          <input id="pipelineMonth" placeholder="YYYY-MM" />
        </div>
      </div>
      <div class="row" style="margin-top:12px; gap:8px;">
        <button id="genWeekBtn" class="primary">Generate Weekly (per Employee)</button>
        <button id="genMonthBtn" class="primary">Generate Monthly Breakdown</button>
        <button id="genBothBtn" style="background:#2ecc71;">Generate Both</button>
      </div>
      <div id="pipelineResult" style="margin-top:12px; padding:10px; background:#f8f9fa; border-radius:4px; display:none;">
        <pre id="pipelineOutput" style="margin:0; white-space:pre-wrap; font-size:12px;"></pre>
      </div>

      <hr/>

      <h2>üóëÔ∏è Close Month (Retention Policy)</h2>
      <div class="row">
        <div class="col">
          <label class="small muted">Month to Close</label>
          <input id="closeMonth" placeholder="YYYY-MM" />
        </div>
        <div class="col">
          <label class="small muted">&nbsp;</label>
          <button id="closeMonthBtn" style="background:#e74c3c; color:white;">Close & Delete Entries</button>
        </div>
      </div>
      <p class="muted small">‚ö†Ô∏è This permanently deletes all time entries for the specified month.</p>

      <hr/>

      <h2>Invoice Export</h2>
      <div class="row">
        <div class="col">
          <label class="small muted">Customer</label>
          <select id="customer"></select>
        </div>
        <div class="col">
          <label class="small muted">Start</label>
          <input id="start" placeholder="YYYY-MM-DD" />
        </div>
        <div class="col">
          <label class="small muted">End</label>
          <input id="end" placeholder="YYYY-MM-DD" />
        </div>
      </div>
      <div class="row" style="margin-top:12px;">
        <div class="col"><button id="exportInvoiceBtn" class="primary">Download Invoice Workbook</button></div>
      </div>

      <p class="muted small" id="msg"></p>
    </div>
  </div>

<script>
function el(id){ return document.getElementById(id); }

async function api(url, opts){
  const r = await fetch(url, opts);
  const j = await r.json().catch(()=>null);
  if (!r.ok) throw new Error((j && j.error) || 'Request failed');
  return j;
}

let submittedCache=[];

async function init(){

  const customers = await api('/api/customers');
  el('customer').innerHTML = customers.map(c=>`<option value="${c.id}">${c.name}</option>`).join('');

  el('loadBtn').onclick = loadSubmitted;
  el('approveBtn').onclick = approveSelected;
  el('exportMonthBtn').onclick = exportMonth;
  el('exportInvoiceBtn').onclick = exportInvoice;

  // Pipeline buttons
  el('genWeekBtn').onclick = generateWeekly;
  el('genMonthBtn').onclick = generateMonthlyBreakdown;
  el('genBothBtn').onclick = generateBoth;
  el('closeMonthBtn').onclick = closeMonth;

  // Set default values for pipeline inputs
  const now = new Date();
  const ym = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
  el('pipelineMonth').value = ym;
  el('closeMonth').value = ym;

  // default week start: ask server by loading approvals once without week
  const data = await api('/api/approvals');
  el('weekStart').value = data.week_start;
  el('pipelineWeek').value = data.week_start;
  submittedCache = data.submitted;
  renderSubmitted(data.submitted);
}

// Pipeline functions
async function generateWeekly() {
  const week_start = el('pipelineWeek').value.trim();
  if (!week_start) { alert('Enter week start date'); return; }
  try {
    showPipelineResult('Generating weekly exports...');
    const result = await api(`/api/admin/generate-week?week_start=${encodeURIComponent(week_start)}`);
    const output = [
      `‚úÖ Weekly Export Complete`,
      `Week: ${result.weekStart}`,
      `Output: ${result.outputDir}`,
      ``,
      `Files Generated (${result.files.length}):`,
      ...result.files.map(f => `  ‚Ä¢ ${f.filename}: ${f.hours}hrs ($${f.amount}) [${f.category}]`),
      ``,
      `Totals:`,
      `  Hours: ${result.totals.totalHours} (${result.totals.totalRegular} reg + ${result.totals.totalOT} OT)`,
      `  Amount: $${result.totals.totalAmount}`,
    ].join('\n');
    showPipelineResult(output);
  } catch (err) {
    showPipelineResult(`‚ùå Error: ${err.message}`);
  }
}

async function generateMonthlyBreakdown() {
  const month = el('pipelineMonth').value.trim();
  if (!month) { alert('Enter month'); return; }
  try {
    showPipelineResult('Generating monthly breakdown...');
    const result = await api(`/api/admin/generate-month?month=${encodeURIComponent(month)}`);
    const output = [
      `‚úÖ Monthly Export Complete`,
      `Month: ${result.month}`,
      `File: ${result.filename}`,
      ``,
      `Summary:`,
      `  Customers: ${result.totals.customers}`,
      `  Employees: ${result.totals.employees}`,
      `  Grand Total: $${result.totals.grandTotal}`,
    ].join('\n');
    showPipelineResult(output);
  } catch (err) {
    showPipelineResult(`‚ùå Error: ${err.message}`);
  }
}

async function generateBoth() {
  try {
    showPipelineResult('Generating both weekly and monthly exports...');
    
    const week_start = el('pipelineWeek').value.trim();
    const month = el('pipelineMonth').value.trim();
    
    const weekResult = week_start ? await api(`/api/admin/generate-week?week_start=${encodeURIComponent(week_start)}`) : null;
    const monthResult = month ? await api(`/api/admin/generate-month?month=${encodeURIComponent(month)}`) : null;
    
    let output = '‚úÖ Export Complete\n\n';
    
    if (weekResult) {
      output += `WEEKLY (${weekResult.weekStart}):\n`;
      output += `  Files: ${weekResult.files.length}\n`;
      output += `  Hours: ${weekResult.totals.totalHours}\n`;
      output += `  Amount: $${weekResult.totals.totalAmount}\n\n`;
    }
    
    if (monthResult) {
      output += `MONTHLY (${monthResult.month}):\n`;
      output += `  File: ${monthResult.filename}\n`;
      output += `  Grand Total: $${monthResult.totals.grandTotal}\n`;
    }
    
    showPipelineResult(output);
  } catch (err) {
    showPipelineResult(`‚ùå Error: ${err.message}`);
  }
}

async function closeMonth() {
  const month = el('closeMonth').value.trim();
  if (!month) { alert('Enter month to close'); return; }
  
  const confirmed = confirm(`‚ö†Ô∏è WARNING: This will permanently delete ALL time entries for ${month}.\n\nAre you sure?`);
  if (!confirmed) return;
  
  const doubleConfirm = confirm(`FINAL CONFIRMATION: Delete all entries for ${month}?`);
  if (!doubleConfirm) return;
  
  try {
    showPipelineResult('Closing month...');
    const result = await api('/api/admin/close-month', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ month, confirm: true })
    });
    showPipelineResult(`‚úÖ ${result.message}`);
  } catch (err) {
    showPipelineResult(`‚ùå Error: ${err.message}`);
  }
}

function showPipelineResult(text) {
  el('pipelineResult').style.display = 'block';
  el('pipelineOutput').textContent = text;
}

async function loadSubmitted(){
  const week_start = el('weekStart').value.trim();
  const data = await api('/api/approvals?week_start=' + encodeURIComponent(week_start));
  submittedCache = data.submitted;
  renderSubmitted(data.submitted);
}

function renderSubmitted(rows){
  if (!rows.length){
    el('submitted').innerHTML = '<p class="muted">No submitted entries.</p>';
    return;
  }
  const html = `
    <table>
      <thead><tr>
        <th></th><th>Date</th><th>Employee</th><th>Customer</th><th>Hours</th>
      </tr></thead>
      <tbody>
        ${rows.map(r=>`
          <tr>
            <td><input type="checkbox" data-id="${r.id}" /></td>
            <td>${r.work_date}</td>
            <td>${r.employee_name}</td>
            <td>${r.customer_name}</td>
            <td>${Number(r.hours)}</td>
          </tr>
        `).join('')}
      </tbody>
    </table>
  `;
  el('submitted').innerHTML = html;
}

async function approveSelected(){
  const ids = [...document.querySelectorAll('input[type=checkbox][data-id]:checked')].map(x=>x.getAttribute('data-id'));
  if (!ids.length) { alert('Select at least one.'); return; }
  await api('/api/approve', {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ ids })
  });
  alert('Approved!');
  await loadSubmitted();
}

function exportMonth(){
  const d = new Date();
  const ym = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
  window.location.href = `/api/export/monthly?month=${encodeURIComponent(ym)}`;
}

function exportInvoice(){
  const customer_id = el('customer').value;
  const start = el('start').value.trim();
  const end = el('end').value.trim();
  if (!customer_id || !start || !end) { alert('Pick customer and start/end dates'); return; }
  window.location.href = `/api/export/invoice?customer_id=${encodeURIComponent(customer_id)}&start=${encodeURIComponent(start)}&end=${encodeURIComponent(end)}`;
}

init().catch(e=>{
  console.error(e);
  alert(e.message || 'Failed to load');
});
</script>
</body>
</html>
