<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Labor Timekeeper - Admin</title>
  <link rel="stylesheet" href="/styles.css" />
</head>
<body>
  <!-- PIN Gate -->
  <div id="pinGate" class="container" style="margin-top:50px;">
    <div class="card" style="max-width:300px; margin:0 auto; text-align:center;">
      <h2>üîí Admin Access</h2>
      <p class="muted small">Enter PIN to continue</p>
      <input id="pinInput" type="password" inputmode="numeric" maxlength="4" placeholder="****" style="font-size:1.5rem; text-align:center; letter-spacing:8px; padding:12px;" />
      <button id="pinBtn" class="primary" style="margin-top:12px; width:100%;">Unlock</button>
      <p id="pinError" class="small" style="color:#e74c3c; margin-top:8px; display:none;">Incorrect PIN</p>
    </div>
  </div>

  <!-- Admin Content (hidden until PIN verified) -->
  <div id="adminContent" class="container" style="display:none;">
    <div class="row" style="align-items:center; justify-content:space-between; gap:12px;">
      <h1>Admin</h1>
      <div style="display:flex; gap:8px; align-items:center;">
        <label style="font-size:13px; display:flex; gap:6px; align-items:center;">
          <input type="checkbox" id="showDevToggle" /> Show Dev Controls
        </label>
        <a href="/app" class="badge">Employee view</a>
      </div>
    </div>

    <div class="card" style="margin-top:12px;">
      <h2>Approvals</h2>
      <div class="row">
        <div class="col">
          <label class="small muted">Week start (YYYY-MM-DD)</label>
          <select id="weekStart"></select>
        </div>
        <div class="col">
          <label class="small muted">&nbsp;</label>
          <button class="primary" id="loadBtn">Load Submitted</button>
        </div>
      </div>

      <div id="submitted" style="margin-top:12px;"></div>

      <div class="row" style="margin-top:12px;">
        <div class="col"><button id="approveBtn" class="primary">Approve Selected</button></div>
      </div>

      <hr/>

      <h2>üìä Payroll Reports</h2>
      <div class="row">
        <div class="col">
          <label class="small muted">Week Start</label>
          <select id="pipelineWeek"></select>
        </div>
        <div class="col">
          <label class="small muted">Month</label>
          <input id="pipelineMonth" placeholder="YYYY-MM" />
        </div>
      </div>
      <div id="devControls">
          <div class="row" style="margin-top:12px; gap:8px;">
            <button id="genWeekBtn" class="primary">‚¨áÔ∏è Weekly Report (per Employee)</button>
            <button id="genMonthBtn" class="primary">‚¨áÔ∏è Monthly Breakdown</button>
            <button id="seedWeeksBtn" class="primary">üå± Simulate Month</button>
          </div>
      </div>
      <div id="pipelineResult" style="margin-top:12px; padding:10px; background:#f8f9fa; border-radius:4px; display:none;">
        <pre id="pipelineOutput" style="margin:0; white-space:pre-wrap; font-size:12px;"></pre>
      </div>

      <hr/>

      <h2>‚úÖ Reconcile Payroll</h2>
      <div class="row">
        <div class="col">
          <label class="small muted">Month to Reconcile</label>
          <input id="closeMonth" placeholder="YYYY-MM" />
        </div>
        <div class="col">
          <label class="small muted">&nbsp;</label>
          <button id="previewReconcileBtn" style="background:#3498db; color:white;">Preview</button>
          <button id="closeMonthBtn" style="background:#e74c3c; color:white;">Reconcile & Clear</button>
        </div>
      </div>
      <p class="muted small">Archives data to cloud storage then clears entries. Only keep 1 month of active data.</p>

      <p class="muted small" id="msg"></p>
    </div>
  </div>
</div>

<script>
const ADMIN_PIN = '7707';
const PIN_KEY = 'labor_timekeeper_admin_auth';

function el(id){ return document.getElementById(id); }

// PIN Gate Logic
function checkPin() {
  const saved = sessionStorage.getItem(PIN_KEY);
  if (saved === 'verified') {
    showAdmin();
    return true;
  }
  return false;
}

function showAdmin() {
  el('pinGate').style.display = 'none';
  el('adminContent').style.display = 'block';
  init();
}

function verifyPin() {
  const pin = el('pinInput').value;
  if (pin === ADMIN_PIN) {
    sessionStorage.setItem(PIN_KEY, 'verified');
    showAdmin();
  } else {
    el('pinError').style.display = 'block';
    el('pinInput').value = '';
    el('pinInput').focus();
  }
}

// Set up PIN handlers
el('pinBtn').onclick = verifyPin;
el('pinInput').onkeydown = (e) => { if (e.key === 'Enter') verifyPin(); };

// Check if already authenticated
if (!checkPin()) {
  el('pinInput').focus();
}

async function api(url, opts){
  const r = await fetch(url, opts);
  const j = await r.json().catch(()=>null);
  if (!r.ok) throw new Error((j && j.error) || 'Request failed');
  return j;
}

let submittedCache=[];

async function init(){
  el('loadBtn').onclick = loadSubmitted;
  el('approveBtn').onclick = approveSelected;

  // Report download buttons
  el('genWeekBtn').onclick = downloadWeekly;
  el('genMonthBtn').onclick = downloadMonthly;
  const seedBtn = el('seedWeeksBtn'); if (seedBtn) seedBtn.onclick = seedSampleWeeks;
  el('previewReconcileBtn').onclick = previewReconcile;
  el('closeMonthBtn').onclick = closeMonth;

  // Set default values for pipeline inputs
  const now = new Date();
  const ym = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
  el('pipelineMonth').value = ym;
  el('closeMonth').value = ym;
  // populate week dropdowns from available exports (falls back to current week)
  await populateWeekSelects();

  // default week start: ask server by loading approvals once without week
  const data = await api('/api/approvals?_=' + Date.now());
  // set defaults on the selects to the server-provided week_start
  setSelectValue('weekStart', data.week_start);
  setSelectValue('pipelineWeek', data.week_start);
  submittedCache = data.submitted;
  renderSubmitted(data.submitted);
}

// Note: Clear test entries button removed ‚Äî use admin endpoints carefully via API.

// Dev controls toggle
function setDevVisibility(visible) {
  const dev = el('devControls');
  if (!dev) return;
  dev.style.display = visible ? 'block' : 'none';
  try { localStorage.setItem('admin_show_dev', visible ? '1' : '0'); } catch(e){}
  const cb = el('showDevToggle'); if (cb) cb.checked = !!visible;
}

function initDevToggle() {
  // Default to showing dev controls when no preference is stored (helps tests/dev)
  const raw = localStorage.getItem('admin_show_dev');
  // Default to NOT showing dev controls when no preference stored
  const pref = raw === null ? false : (raw === '1');
  setDevVisibility(pref);
  const cb = el('showDevToggle');
  if (!cb) return;
  cb.onchange = () => setDevVisibility(cb.checked);
}

// Initialize dev toggle state on load
initDevToggle();

function setSelectValue(id, value) {
  const s = el(id);
  if (!s) return;
  // if option exists select it, otherwise add an option and select
  const opt = Array.from(s.options).find(o => o.value === value);
  if (opt) {
    s.value = value;
  } else if (value) {
    const newOpt = document.createElement('option');
    newOpt.value = value;
    newOpt.textContent = value + ' (default)';
    s.prepend(newOpt);
    s.value = value;
  }
}

async function populateWeekSelects(){
  try {
    const resp = await api('/api/exports?_=' + Date.now());
    const exports = resp.exports || [];
    const weekOptions = [];
    for (const m of exports) {
      for (const w of m.weeks) {
        weekOptions.push({ month: m.month, week: w });
      }
    }

    // If no exports found, include current week start
    if (weekOptions.length === 0) {
      const today = new Date();
      const y = today.getFullYear();
      const m = String(today.getMonth() + 1).padStart(2, '0');
      const d = String(today.getDate()).padStart(2, '0');
      const defaultWeek = `${y}-${m}-${d}`;
      weekOptions.push({ month: `${y}-${m}`, week: defaultWeek });
    }

    const weeksSorted = weekOptions.sort((a,b) => (a.week < b.week ? 1 : -1));

    const wkSel = el('weekStart');
    const pipelineSel = el('pipelineWeek');
    if (!wkSel || !pipelineSel) return;

    // clear existing
    wkSel.innerHTML = '';
    pipelineSel.innerHTML = '';

    // Group by month for nicer labels
    const grouped = {};
    for (const w of weeksSorted) {
      grouped[w.month] = grouped[w.month] || [];
      grouped[w.month].push(w.week);
    }

    for (const month of Object.keys(grouped)) {
      const optGroupLabel = month;
      for (const wk of grouped[month]) {
        const o1 = document.createElement('option');
        o1.value = wk;
        o1.textContent = `${wk} (${optGroupLabel})`;
        wkSel.appendChild(o1);

        const o2 = document.createElement('option');
        o2.value = wk;
        o2.textContent = `${wk} (${optGroupLabel})`;
        pipelineSel.appendChild(o2);
      }
    }
  } catch (err) {
    console.warn('Failed to populate week selects', err);
  }
}

async function simulateWeek(){
  const week_start = el('pipelineWeek').value.trim();
  if (!week_start) { alert('Enter week start date'); return; }
  const reset = !!el('simReset').checked;
  const submit = !!el('simSubmit').checked;
  const approve = !!el('simApprove').checked;

  if (!confirm(`Simulate week ${week_start}?\nReset: ${reset}\nSubmit: ${submit}\nApprove: ${approve}`)) return;

  try {
    showPipelineResult('Simulating week...');
    const result = await api('/api/admin/simulate-week', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ week_start, reset, submit, approve })
    });
    const output = [
      `üß™ Simulate Week: ${result.week_start}`,
      `Created: ${result.created}`,
      `Skipped: ${result.skipped}`,
      `Deleted: ${result.deleted}`,
      `Options: reset=${result.options.reset}, submit=${result.options.submit}, approve=${result.options.approve}`
    ].join('\n');
    showPipelineResult(output);
  } catch (err) {
    showPipelineResult(`‚ùå Error: ${err.message}`);
  }
}

async function seedSampleWeeks(){
  const month = (el('pipelineMonth').value || '').trim();
  if (!month) { alert('Enter month (YYYY-MM) to seed'); return; }
  // Default to submitted+approved so seeded data is ready for exports/tests
  const submit = true;
  const approve = true;
  if (!confirm(`Seed entries for month ${month}?\nThis will create weekly entries for the entire month as SUBMITTED+APPROVED for admin review.`)) return;
  try {
    showPipelineResult(`Seeding month entries (SUBMITTED+APPROVED)...`);
    const result = await api('/api/admin/simulate-month', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ month, reset: true, submit, approve }) });
    const output = `‚úÖ Seeded month ${month}:\n${JSON.stringify(result, null, 2)}`;
    showPipelineResult(output);
  } catch (err) {
    showPipelineResult(`‚ùå Error: ${err.message}`);
  }
}

// Report download functions
async function downloadWeekly() {
  const week_start = el('pipelineWeek').value.trim();
  if (!week_start) { alert('Enter week start date'); return; }
  try {
    showPipelineResult('Generating weekly exports...');
    const result = await api(`/api/admin/generate-week?week_start=${encodeURIComponent(week_start)}`);
    
    if (result.files && result.files.length > 0) {
      const totals = result.totals || {};
      const output = [
        `‚úÖ Weekly Export Complete`,
        `Week: ${result.weekStart}`,
        ``,
        `Files Generated (${result.files.length}):`,
        ...result.files.map(f => `  ‚Ä¢ ${f.filename}: ${f.hours}hrs ($${f.amount})`),
        ``,
        `Totals: ${totals.totalHours} hours ‚Äî $${totals.totalAmount}`,
        `  ‚Ä¢ Hourly: $${totals.hourlyAmount || 0}`,
        `  ‚Ä¢ Admin: $${totals.adminAmount || 0}`,
        ``,
        `Files saved to: ${result.outputDir}`,
      ].join('\n');
      showPipelineResult(output);
    } else {
      showPipelineResult('No approved entries found for this week.');
    }
  } catch (err) {
    showPipelineResult(`‚ùå Error: ${err.message}`);
  }
}

async function downloadMonthly() {
  const month = el('pipelineMonth').value.trim();
  if (!month) { alert('Enter month (YYYY-MM)'); return; }
  // Directly download the file; do not auto-seed. Use the Simulate button to populate data.
  window.location.href = `/api/export/monthly?month=${encodeURIComponent(month)}`;
}

async function previewReconcile() {
  const month = el('closeMonth').value.trim();
  if (!month) { alert('Enter month to reconcile'); return; }
  
  try {
    showPipelineResult('Loading preview...');
    const result = await api('/api/admin/reconcile', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ month, confirm: false })
    });
    const output = [
      `üìã Reconciliation Preview for ${month}`,
      ``,
      `Entries to archive: ${result.entries}`,
      `Total Hours: ${result.totalHours}`,
      `Total Billed: $${result.totalBilled}`,
      ``,
      `Click "Reconcile & Clear" to archive and remove this data.`
    ].join('\n');
    showPipelineResult(output);
  } catch (err) {
    showPipelineResult(`‚ùå Error: ${err.message}`);
  }
}

async function closeMonth() {
  const month = el('closeMonth').value.trim();
  if (!month) { alert('Enter month to reconcile'); return; }
  
  const confirmed = confirm(`‚ö†Ô∏è This will archive and clear ALL time entries for ${month}.\n\nData will be saved to cloud storage but removed from active database.\n\nContinue?`);
  if (!confirmed) return;
  
  try {
    showPipelineResult('Archiving and clearing...');
    const result = await api('/api/admin/reconcile', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ month, confirm: true })
    });
    const output = [
      `‚úÖ Payroll Reconciled for ${month}`,
      ``,
      `Archived: ${result.archived} entries`,
      `Total Hours: ${result.summary.totalHours}`,
      `Total Billed: $${result.summary.totalBilled}`,
      ``,
      `Data has been archived and cleared from active database.`
    ].join('\n');
    showPipelineResult(output);
  } catch (err) {
    showPipelineResult(`‚ùå Error: ${err.message}`);
  }
}

function showPipelineResult(text) {
  el('pipelineResult').style.display = 'block';
  el('pipelineOutput').textContent = text;
}

async function loadSubmitted(){
  // Try selected week, fall back to pipelineWeek, otherwise load current week
  const week_start = (el('weekStart').value || el('pipelineWeek').value || '').trim();
  const qs = week_start ? ('?week_start=' + encodeURIComponent(week_start) + '&_=' + Date.now()) : ('?_=' + Date.now());
  const data = await api('/api/approvals' + qs);
  submittedCache = data.submitted;
  renderSubmitted(data.submitted);
}

function renderSubmitted(rows){
  if (!rows.length){
    el('submitted').innerHTML = '<p class="muted">No submitted entries.</p>';
    return;
  }
  const totalHours = rows.reduce((sum, r) => sum + Number(r.hours), 0);
  const html = `
    <table>
      <thead><tr>
        <th><input type="checkbox" id="selectAll" title="Select All" /></th>
        <th>Date</th><th>Employee</th><th>Customer</th><th>Hours</th>
      </tr></thead>
      <tbody>
        ${rows.map(r=>`
          <tr>
            <td><input type="checkbox" class="entry-cb" data-id="${r.id}" /></td>
            <td>${r.work_date}</td>
            <td>${r.employee_name}</td>
            <td>${r.customer_name}</td>
            <td>${Number(r.hours)}</td>
          </tr>
        `).join('')}
      </tbody>
      <tfoot><tr style="font-weight:bold; background:#f0f0f0;">
        <td></td><td colspan="3">Total (${rows.length} entries)</td><td>${totalHours}</td>
      </tr></tfoot>
    </table>
  `;
  el('submitted').innerHTML = html;
  
  // Select All handler
  el('selectAll').onchange = function() {
    document.querySelectorAll('.entry-cb').forEach(cb => cb.checked = this.checked);
  };
  // Update Select All when individual boxes change
  document.querySelectorAll('.entry-cb').forEach(cb => {
    cb.onchange = updateSelectAllState;
  });
}

function updateSelectAllState() {
  const all = document.querySelectorAll('.entry-cb');
  const checked = document.querySelectorAll('.entry-cb:checked');
  const selectAll = el('selectAll');
  if (selectAll) {
    selectAll.checked = all.length > 0 && all.length === checked.length;
    selectAll.indeterminate = checked.length > 0 && checked.length < all.length;
  }
}

async function approveSelected(){
  const ids = [...document.querySelectorAll('.entry-cb:checked')].map(x=>x.getAttribute('data-id'));
  if (!ids.length) { alert('Select at least one.'); return; }
  await api('/api/approve', {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ ids })
  });
  alert(`Approved ${ids.length} entries!`);
  await loadSubmitted();
}

init().catch(e=>{
  console.error(e);
  alert(e.message || 'Failed to load');
});
</script>
</body>
</html>
