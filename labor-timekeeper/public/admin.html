<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Labor Timekeeper - Admin</title>
  <link rel="stylesheet" href="/styles.css" />
</head>
<body>
  <!-- Admin Secret Gate -->
  <div id="secretGate" class="container" style="margin-top:50px;">
    <div class="card" style="max-width:320px; margin:0 auto; text-align:center;">
      <h2>Admin Secret</h2>
      <p class="muted small">Enter admin secret to continue</p>
      <input id="secretInput" type="password" placeholder="********" style="font-size:1.1rem; text-align:center; letter-spacing:3px; padding:12px;" />
      <button id="secretBtn" class="primary" style="margin-top:12px; width:100%;">Unlock</button>
      <p id="secretError" class="small" style="color:#e74c3c; margin-top:8px; display:none;">Incorrect admin secret</p>
    </div>
  </div>

  <!-- PIN Gate -->
  <div id="pinGate" class="container" style="margin-top:50px; display:none;">
    <div class="card" style="max-width:300px; margin:0 auto; text-align:center;">
      <h2>üîí Admin Access</h2>
      <p class="muted small">Enter PIN to continue</p>
      <input id="pinInput" type="password" inputmode="numeric" maxlength="4" placeholder="****" style="font-size:1.5rem; text-align:center; letter-spacing:8px; padding:12px;" />
      <button id="pinBtn" class="primary" style="margin-top:12px; width:100%;">Unlock</button>
      <p id="pinError" class="small" style="color:#e74c3c; margin-top:8px; display:none;">Incorrect PIN</p>
    </div>
  </div>

  <!-- Admin Content (hidden until PIN verified) -->
  <div id="adminContent" class="container" style="display:none;">
    <div class="row" style="align-items:center; justify-content:space-between; gap:12px;">
      <h1>Admin</h1>
      <div style="display:flex; gap:8px; align-items:center;">
        <button id="toggleDevBtn" class="badge" type="button">Show Sim Tools</button>
        <a href="/app" class="badge">Employee view</a>
      </div>
    </div>

    <div class="card" style="margin-top:12px;">
      <h2>Approvals</h2>
      <div class="row">
        <div class="col">
          <label class="small muted">Payroll Week</label>
          <div id="payrollWeekLabel" class="small muted"></div>
        </div>
        <div class="col">
          <label class="small muted">&nbsp;</label>
          <button class="primary" id="loadBtn">Load Submitted</button>
        </div>
      </div>

      <div id="submitted" style="margin-top:12px;"></div>

      <div class="row" style="margin-top:12px;">
        <div class="col"><button id="approveBtn" class="primary">Approve Selected</button></div>
      </div>

      <hr/>

      <h2>üìä Payroll Reports</h2>
      <div class="row">
        <div class="col">
          <label class="small muted">Payroll Week</label>
          <div id="reportWeekLabel" class="small muted"></div>
        </div>
        <div class="col">
          <label class="small muted">Month</label>
          <div id="reportMonthLabel" class="small muted"></div>
        </div>
      </div>
      <div class="row" style="margin-top:12px; gap:8px;">
        <button id="genWeekBtn" class="primary">‚¨áÔ∏è Weekly Report (per Employee)</button>
        <button id="genMonthBtn" class="primary">‚¨áÔ∏è Monthly Breakdown</button>
      </div>
      <div id="devControls">
          <div class="row" style="margin-top:12px; gap:8px;">
            <button id="seedWeeksBtn" class="primary">üå± Simulate Month</button>
          </div>
      </div>
      <div id="pipelineResult" style="margin-top:12px; padding:10px; background:#f8f9fa; border-radius:4px; display:none;">
        <pre id="pipelineOutput" style="margin:0; white-space:pre-wrap; font-size:12px;"></pre>
      </div>

      <hr/>

      <h2>‚úÖ Reconcile Payroll</h2>
      <div class="row">
        <div class="col">
          <label class="small muted">Month to Reconcile</label>
          <input id="closeMonth" placeholder="YYYY-MM" />
        </div>
        <div class="col">
          <label class="small muted">&nbsp;</label>
          <button id="previewReconcileBtn" style="background:#3498db; color:white;">Preview</button>
          <button id="closeMonthBtn" style="background:#e74c3c; color:white;">Reconcile & Clear</button>
        </div>
      </div>
      <p class="muted small">Archives data to cloud storage then clears entries. Only keep 1 month of active data.</p>

      <p class="muted small" id="msg"></p>
    </div>
  </div>
</div>

<script>
const ADMIN_PIN = '7707';
const SECRET_KEY = 'labor_timekeeper_admin_secret';
let ADMIN_SECRET = '';
const IS_PROD_HOST = location.hostname.endsWith('appspot.com');
const FORCE_DEV = new URLSearchParams(location.search).get('dev') === '1';
const PIN_KEY = 'labor_timekeeper_admin_auth';

function el(id){ return document.getElementById(id); }

// Admin Secret Gate Logic
async function verifySecret() {
  const input = el('secretInput').value;
  if (!input) return;
  const r = await fetch('/api/admin/schema', {
    headers: { 'x-admin-secret': input }
  });
  if (r.ok) {
    ADMIN_SECRET = input;
    sessionStorage.setItem(SECRET_KEY, input);
    el('secretGate').style.display = 'none';
    el('pinGate').style.display = 'block';
    el('pinInput').focus();
  } else {
    el('secretError').style.display = 'block';
    el('secretInput').value = '';
    el('secretInput').focus();
  }
}

function initSecretGate() {
  el('secretGate').style.display = 'block';
  el('pinGate').style.display = 'none';
  el('secretBtn').onclick = verifySecret;
  el('secretInput').onkeydown = (e) => { if (e.key === 'Enter') verifySecret(); };
  el('secretInput').focus();
}

// PIN Gate Logic
function checkPin() {
  const saved = sessionStorage.getItem(PIN_KEY);
  if (saved === 'verified') {
    showAdmin();
    return true;
  }
  return false;
}

function showAdmin() {
  el('pinGate').style.display = 'none';
  el('secretGate').style.display = 'none';
  el('adminContent').style.display = 'block';
  init();
}

function verifyPin() {
  const pin = el('pinInput').value;
  if (pin === ADMIN_PIN) {
    sessionStorage.setItem(PIN_KEY, 'verified');
    showAdmin();
  } else {
    el('pinError').style.display = 'block';
    el('pinInput').value = '';
    el('pinInput').focus();
  }
}

// Set up PIN handlers
el('pinBtn').onclick = verifyPin;
el('pinInput').onkeydown = (e) => { if (e.key === 'Enter') verifyPin(); };

// Init secret gate + then PIN gate
initSecretGate();
if (!checkPin()) {
  // PIN gate remains until verified
}

async function api(url, opts){
  const headers = { ...(opts && opts.headers ? opts.headers : {}) };
  if (ADMIN_SECRET) headers['x-admin-secret'] = ADMIN_SECRET;
  const r = await fetch(url, { ...(opts || {}), headers });
  const j = await r.json().catch(()=>null);
  if (!r.ok) throw new Error((j && j.error) || 'Request failed');
  return j;
}

let submittedCache=[];
let CURRENT_WEEK_START = '';
let CURRENT_WEEK_RANGE = '';
let CURRENT_MONTH = '';

async function init(){
  el('loadBtn').onclick = loadSubmitted;
  el('approveBtn').onclick = approveSelected;

  // Report download buttons
  el('genWeekBtn').onclick = downloadWeekly;
  el('genMonthBtn').onclick = downloadMonthly;
  const seedBtn = el('seedWeeksBtn'); if (seedBtn) seedBtn.onclick = seedSampleWeeks;
  el('previewReconcileBtn').onclick = previewReconcile;
  el('closeMonthBtn').onclick = closeMonth;

  // Default month values
  const now = new Date();
  const ym = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
  CURRENT_MONTH = ym;
  el('reportMonthLabel').textContent = ym;
  el('closeMonth').value = ym;

  // Default week start: ask server by loading approvals once without week
  const data = await api('/api/approvals?_=' + Date.now());
  CURRENT_WEEK_START = data.week_start || '';
  const days = data.days || [];
  const start = days[0]?.ymd || data.week_start;
  const end = days[6]?.ymd || data.week_start;
  CURRENT_WEEK_RANGE = (start && end) ? `${start} to ${end}` : (data.week_start || '');
  el('payrollWeekLabel').textContent = CURRENT_WEEK_RANGE;
  el('reportWeekLabel').textContent = CURRENT_WEEK_RANGE;
  submittedCache = data.submitted;
  renderSubmitted(data.submitted);
}

// Note: Clear test entries button removed ‚Äî use admin endpoints carefully via API.

// Dev controls toggle
function setDevVisibility(visible) {
  const dev = el('devControls');
  if (!dev) return;
  dev.style.display = visible ? 'block' : 'none';
}

function initDevToggle() {
  const btn = el('toggleDevBtn');
  const dev = el('devControls');
  if (!btn || !dev) return;
  setDevVisibility(false);
  btn.textContent = 'Show Sim Tools';
  btn.onclick = () => {
    const isVisible = dev.style.display !== 'none';
    const next = !isVisible;
    setDevVisibility(next);
    btn.textContent = next ? 'Hide Sim Tools' : 'Show Sim Tools';
  };
}

// Initialize dev toggle state on load
initDevToggle();

// Week dropdowns removed; use current week from server

async function seedSampleWeeks(){
  const month = CURRENT_MONTH;
  if (!month) { alert('Missing current month'); return; }
  // Default to submitted+approved so seeded data is ready for exports/tests
  const submit = true;
  const approve = true;
  if (!confirm(`Seed entries for month ${month}?\nThis will create weekly entries for the entire month as SUBMITTED+APPROVED for admin review.`)) return;
  try {
    showPipelineResult(`Seeding month entries (SUBMITTED+APPROVED)...`);
    const result = await api('/api/admin/simulate-month', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ month, reset: true, submit, approve }) });
    const output = `‚úÖ Seeded month ${month}:\n${JSON.stringify(result, null, 2)}`;
    showPipelineResult(output);
  } catch (err) {
    showPipelineResult(`‚ùå Error: ${err.message}`);
  }
}

// Report download functions
async function downloadWeekly() {
  const week_start = CURRENT_WEEK_START;
  if (!week_start) { alert('Missing current week'); return; }
  try {
    showPipelineResult('Generating weekly exports...');
    const result = await api(`/api/admin/generate-week?week_start=${encodeURIComponent(week_start)}`);
    
    if (result.files && result.files.length > 0) {
      const totals = result.totals || {};
      const output = [
        `‚úÖ Weekly Export Complete`,
        `Week: ${result.weekStart}`,
        ``,
        `Files Generated (${result.files.length}):`,
        ...result.files.map(f => `  ‚Ä¢ ${f.filename}: ${f.hours}hrs ($${f.amount})`),
        ``,
        `Totals: ${totals.totalHours} hours ‚Äî $${totals.totalAmount}`,
        `  ‚Ä¢ Hourly: $${totals.hourlyAmount || 0}`,
        `  ‚Ä¢ Admin: $${totals.adminAmount || 0}`,
        ``,
        `Files saved to: ${result.outputDir}`,
      ].join('\n');
      showPipelineResult(output);
    } else {
      showPipelineResult('No approved entries found for this week.');
    }
  } catch (err) {
    showPipelineResult(`‚ùå Error: ${err.message}`);
  }
}

async function downloadMonthly() {
  const month = CURRENT_MONTH;
  if (!month) { alert('Missing current month'); return; }
  // Directly download the file; do not auto-seed. Use the Simulate button to populate data.
  window.location.href = `/api/export/monthly?month=${encodeURIComponent(month)}`;
}

async function previewReconcile() {
  const month = el('closeMonth').value.trim();
  if (!month) { alert('Enter month to reconcile'); return; }
  
  try {
    showPipelineResult('Loading preview...');
    const result = await api('/api/admin/reconcile', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ month, confirm: false })
    });
    const output = [
      `üìã Reconciliation Preview for ${month}`,
      ``,
      `Entries to archive: ${result.entries}`,
      `Total Hours: ${result.totalHours}`,
      `Total Billed: $${result.totalBilled}`,
      ``,
      `Click "Reconcile & Clear" to archive and remove this data.`
    ].join('\n');
    showPipelineResult(output);
  } catch (err) {
    showPipelineResult(`‚ùå Error: ${err.message}`);
  }
}

async function closeMonth() {
  const month = el('closeMonth').value.trim();
  if (!month) { alert('Enter month to reconcile'); return; }
  
  const confirmed = confirm(`‚ö†Ô∏è This will archive and clear ALL time entries for ${month}.\n\nData will be saved to cloud storage but removed from active database.\n\nContinue?`);
  if (!confirmed) return;
  
  try {
    showPipelineResult('Archiving and clearing...');
    const result = await api('/api/admin/reconcile', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ month, confirm: true })
    });
    const output = [
      `‚úÖ Payroll Reconciled for ${month}`,
      ``,
      `Archived: ${result.archived} entries`,
      `Total Hours: ${result.summary.totalHours}`,
      `Total Billed: $${result.summary.totalBilled}`,
      ``,
      `Data has been archived and cleared from active database.`
    ].join('\n');
    showPipelineResult(output);
  } catch (err) {
    showPipelineResult(`‚ùå Error: ${err.message}`);
  }
}

function showPipelineResult(text) {
  el('pipelineResult').style.display = 'block';
  el('pipelineOutput').textContent = text;
}

async function loadSubmitted(){
  const week_start = CURRENT_WEEK_START;
  const qs = week_start ? ('?week_start=' + encodeURIComponent(week_start) + '&_=' + Date.now()) : ('?_=' + Date.now());
  const data = await api('/api/approvals' + qs);
  submittedCache = data.submitted;
  renderSubmitted(data.submitted);
}

function renderSubmitted(rows){
  if (!rows.length){
    el('submitted').innerHTML = '<p class="muted">No submitted entries.</p>';
    return;
  }
  const totalHours = rows.reduce((sum, r) => sum + Number(r.hours), 0);
  const html = `
    <table>
      <thead><tr>
        <th><input type="checkbox" id="selectAll" title="Select All" /></th>
        <th>Date</th><th>Employee</th><th>Customer</th><th>Hours</th>
      </tr></thead>
      <tbody>
        ${rows.map(r=>`
          <tr>
            <td><input type="checkbox" class="entry-cb" data-id="${r.id}" /></td>
            <td>${r.work_date}</td>
            <td>${r.employee_name}</td>
            <td>${r.customer_name}</td>
            <td>${Number(r.hours)}</td>
          </tr>
        `).join('')}
      </tbody>
      <tfoot><tr style="font-weight:bold; background:#f0f0f0;">
        <td></td><td colspan="3">Total (${rows.length} entries)</td><td>${totalHours}</td>
      </tr></tfoot>
    </table>
  `;
  el('submitted').innerHTML = html;
  
  // Select All handler
  el('selectAll').onchange = function() {
    document.querySelectorAll('.entry-cb').forEach(cb => cb.checked = this.checked);
  };
  // Update Select All when individual boxes change
  document.querySelectorAll('.entry-cb').forEach(cb => {
    cb.onchange = updateSelectAllState;
  });
}

function updateSelectAllState() {
  const all = document.querySelectorAll('.entry-cb');
  const checked = document.querySelectorAll('.entry-cb:checked');
  const selectAll = el('selectAll');
  if (selectAll) {
    selectAll.checked = all.length > 0 && all.length === checked.length;
    selectAll.indeterminate = checked.length > 0 && checked.length < all.length;
  }
}

async function approveSelected(){
  const ids = [...document.querySelectorAll('.entry-cb:checked')].map(x=>x.getAttribute('data-id'));
  if (!ids.length) { alert('Select at least one.'); return; }
  await api('/api/approve', {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ ids })
  });
  alert(`Approved ${ids.length} entries!`);
  await loadSubmitted();
}

init().catch(e=>{
  console.error(e);
  alert(e.message || 'Failed to load');
});
</script>
</body>
</html>
