<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Labor Timekeeper - Admin</title>
  <link rel="stylesheet" href="/styles.css" />
</head>
<body>
  <!-- Admin Secret Gate -->
  <div id="secretGate" class="container" style="margin-top:50px;">
    <div class="card" style="max-width:320px; margin:0 auto; text-align:center;">
      <h2>Admin Secret</h2>
      <p class="muted small">Enter admin secret to continue</p>
      <input id="secretInput" type="password" placeholder="********" style="font-size:1.1rem; text-align:center; letter-spacing:3px; padding:12px;" />
      <button id="secretBtn" class="primary" style="margin-top:12px; width:100%;">Unlock</button>
      <p id="secretError" class="small" style="color:#e74c3c; margin-top:8px; display:none;">Incorrect admin secret</p>
    </div>
  </div>

  <!-- Admin Content (hidden until secret verified) -->
  <div id="adminContent" class="container" style="display:none;">
    <div class="row" style="align-items:center; justify-content:space-between; gap:12px;">
      <h1>Admin</h1>
      <div style="display:flex; gap:8px; align-items:center;">
        <button id="toggleDevBtn" class="badge" type="button" style="display:none;">Show Sim Tools</button>
        <a href="/app" class="badge">Employee view</a>
      </div>
    </div>

    <div class="card" style="margin-top:12px;">
      <h2>Approvals</h2>
      <div class="row">
        <div class="col">
          <label class="small muted">Payroll Week</label>
          <div id="payrollWeekLabel" class="small muted"></div>
          <div style="margin-top:6px; display:flex; gap:8px; align-items:center;">
            <select id="weekSelect"></select>
            <button id="loadWeekBtn" class="badge" type="button">Load Week</button>
          </div>
        </div>
      </div>

      <div id="submitted" style="margin-top:12px;"></div>

      <div class="row" style="margin-top:12px;">
        <div class="col"><button id="approveBtn" class="primary">Approve Selected</button></div>
        <div class="col"><button id="allEntriesBtn" style="background:#8e44ad;color:white;">All Entries</button></div>
      </div>

      <div id="allEntries" style="margin-top:12px;display:none;">
        <h3>All Entries (DRAFT, SUBMITTED, APPROVED)</h3>
        <div id="allEntriesList"></div>
      </div>

      <hr/>

      <h2>üìä Payroll Report</h2>
      <div class="row">
        <div class="col">
          <label class="small muted">Payroll Week</label>
          <div id="reportWeekLabel" class="small muted"></div>
        </div>
        <div class="col">
          <label class="small muted">Month</label>
          <div id="reportMonthLabel" class="small muted"></div>
          <div style="margin-top:6px; display:flex; gap:8px; align-items:center;">
            <select id="monthSelect"></select>
            <button id="loadMonthBtn" class="badge" type="button">Load Month</button>
          </div>
        </div>
      </div>
      <div class="row" style="margin-top:12px; gap:8px;">
        <button id="genMonthBtn" class="primary">üõ†Ô∏è Download Monthly XLSX</button>
        <button id="genBillingBtn" class="primary" style="background:#2d8a4e">üí∞ Download Billing Report</button>
        <button onclick="printWeekTimesheets()" class="primary" style="background:#1a56db">üñ®Ô∏è Print Payroll</button>
        <button onclick="printWeekBilling()" class="primary" style="background:#0e7490">üí∞ Print Billing</button>
        <button id="previewMonthBtn" class="badge">üìä Preview Report</button>
      </div>
      <div id="devControls" style="display:none;">
          <div class="row" style="margin-top:12px; gap:8px;">
            <button id="seedWeeksBtn" class="primary">üå± Simulate Month</button>
          </div>
      </div>
      <div id="pipelineResult" style="margin-top:12px; padding:10px; background:#f8f9fa; border-radius:4px; display:none;">
        <pre id="pipelineOutput" style="margin:0; white-space:pre-wrap; font-size:12px;"></pre>
      </div>
      <div id="reportPreview" style="margin-top:12px; padding:10px; background:#111a33; border-radius:8px; display:none;"></div>

      <hr/>

      <h2>‚úÖ Reconcile Payroll</h2>
      <div class="row">
        <div class="col">
          <label class="small muted">Month to Reconcile</label>
          <input id="closeMonth" placeholder="YYYY-MM" />
        </div>
        <div class="col">
          <label class="small muted">&nbsp;</label>
          <button id="previewReconcileBtn" style="background:#3498db; color:white;">Preview</button>
          <button id="closeMonthBtn" style="background:#e74c3c; color:white;">Reconcile & Clear</button>
        </div>
      </div>
      <p class="muted small">Archives data to cloud storage then clears entries. Only keep 1 month of active data.</p>

      <p class="muted small" id="msg"></p>
    </div>
  </div>
</div>

<script>
const SECRET_KEY = 'labor_timekeeper_admin_secret';
let ADMIN_SECRET = '';
const IS_PROD_HOST = location.hostname.endsWith('appspot.com');
const FORCE_DEV = new URLSearchParams(location.search).get('dev') === '1';

function el(id){ return document.getElementById(id); }

// Admin Secret Gate Logic
async function verifySecret() {
  const input = el('secretInput').value;
  if (!input) return;
  const r = await fetch('/api/admin/schema', {
    headers: { 'x-admin-secret': input }
  });
  if (r.ok) {
    ADMIN_SECRET = input;
    sessionStorage.setItem(SECRET_KEY, input);
    showAdmin();
  } else {
    el('secretError').style.display = 'block';
    el('secretInput').value = '';
    el('secretInput').focus();
  }
}

function initSecretGate() {
  el('secretGate').style.display = 'block';
  el('secretBtn').onclick = verifySecret;
  el('secretInput').onkeydown = (e) => { if (e.key === 'Enter') verifySecret(); };
  el('secretInput').focus();
}

function showAdmin() {
  el('secretGate').style.display = 'none';
  el('adminContent').style.display = 'block';
  init();
}

// Init secret gate only
initSecretGate();

async function api(url, opts){
  const headers = { ...(opts && opts.headers ? opts.headers : {}) };
  if (ADMIN_SECRET) headers['x-admin-secret'] = ADMIN_SECRET;
  const r = await fetch(url, { ...(opts || {}), headers });
  const j = await r.json().catch(()=>null);
  if (!r.ok) throw new Error((j && j.error) || 'Request failed');
  return j;
}

let submittedCache=[];
let CURRENT_WEEK_START = '';
let CURRENT_WEEK_RANGE = '';
let CURRENT_MONTH = '';

function shiftYmd(ymd, days){
  const [y,m,d] = (ymd || '').split('-').map(Number);
  if (!y || !m || !d) return ymd;
  const dt = new Date(Date.UTC(y, m - 1, d, 12, 0, 0));
  dt.setUTCDate(dt.getUTCDate() + Number(days || 0));
  const yyyy = dt.getUTCFullYear();
  const mm = String(dt.getUTCMonth() + 1).padStart(2, '0');
  const dd = String(dt.getUTCDate()).padStart(2, '0');
  return `${yyyy}-${mm}-${dd}`;
}

function buildWeekOptions(currentWeekStart, weeks){
  const select = el('weekSelect');
  if (!select) return;
  select.innerHTML = '';
  const list = (weeks && weeks.length) ? weeks : (() => {
    const fallback = [];
    let ws = currentWeekStart;
    for (let i = 0; i < 6; i += 1) {
      fallback.push(ws);
      ws = shiftYmd(ws, -7);
    }
    return fallback;
  })();
  for (const w of list) {
    const opt = document.createElement('option');
    opt.value = w;
    opt.textContent = w;
    select.appendChild(opt);
  }
  select.value = currentWeekStart;
}

async function loadWeek(weekStart){
  if (!weekStart) return;
  CURRENT_WEEK_START = weekStart;
  // Keep dropdown in sync
  const sel = el('weekSelect');
  if (sel && sel.value !== weekStart) sel.value = weekStart;
  const qs = weekStart ? ('?week_start=' + encodeURIComponent(weekStart) + '&_=' + Date.now()) : ('?_=' + Date.now());
  const data = await api('/api/approvals' + qs);
  const days = data.days || [];
  const start = days[0]?.ymd || data.week_start;
  const end = days[6]?.ymd || data.week_start;
  CURRENT_WEEK_RANGE = (start && end) ? `${start} to ${end}` : (data.week_start || '');
  el('payrollWeekLabel').textContent = CURRENT_WEEK_RANGE;
  el('reportWeekLabel').textContent = CURRENT_WEEK_RANGE;
  submittedCache = data.submitted;
  renderSubmitted(data.submitted, data.comments || []);
}

function buildMonthOptions(currentMonth){
  const select = el('monthSelect');
  if (!select) return;
  select.innerHTML = '';
  const now = new Date();
  const year = now.getFullYear();
  for (let i = 0; i < 12; i += 1) {
    const d = new Date(Date.UTC(year, i, 1, 12, 0, 0));
    const ym = `${year}-${String(i + 1).padStart(2, '0')}`;
    const opt = document.createElement('option');
    opt.value = ym;
    opt.textContent = ym;
    select.appendChild(opt);
  }
  select.value = currentMonth;
}

async function loadMonth(month){
  if (!month) return;
  CURRENT_MONTH = month;
  el('reportMonthLabel').textContent = month;
  try {
    const res = await api(`/api/admin/weeks?month=${encodeURIComponent(month)}`);
    const weeks = res.weeks || [];
    // Default to the current/latest week rather than the earliest
    const now = new Date();
    const todayYmd = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')}`;
    // Find the closest week that is <= today, or fall back to the last week
    let defaultWeek = weeks[weeks.length - 1] || CURRENT_WEEK_START;
    for (let i = weeks.length - 1; i >= 0; i--) {
      if (weeks[i] <= todayYmd) { defaultWeek = weeks[i]; break; }
    }
    buildWeekOptions(defaultWeek, weeks);
    if (defaultWeek) await loadWeek(defaultWeek);
  } catch (err) {
    buildWeekOptions(CURRENT_WEEK_START);
  }
}

async function init(){
  el('approveBtn').onclick = approveSelected;
  el('allEntriesBtn').onclick = loadAllEntries;
  if (el('loadWeekBtn')) {
    el('loadWeekBtn').onclick = async () => {
      const ws = el('weekSelect')?.value || CURRENT_WEEK_START;
      await loadWeek(ws);
    };
  }

  // Report download buttons
  el('genMonthBtn').onclick = downloadMonthly;
  el('genBillingBtn').onclick = downloadBilling;
  const previewBtn = el('previewMonthBtn'); if (previewBtn) previewBtn.onclick = previewReport;
  const seedBtn = el('seedWeeksBtn'); if (seedBtn) seedBtn.style.display = 'none';
  el('previewReconcileBtn').onclick = previewReconcile;
  el('closeMonthBtn').onclick = closeMonth;

  // Default month values
  const now = new Date();
  const ym = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
  CURRENT_MONTH = ym;
  el('reportMonthLabel').textContent = ym;
  el('closeMonth').value = ym;
  buildMonthOptions(CURRENT_MONTH);
  if (el('loadMonthBtn')) {
    el('loadMonthBtn').onclick = async () => {
      const m = el('monthSelect')?.value || CURRENT_MONTH;
      await loadMonth(m);
    };
  }

  // Default week start: ask server by loading approvals once without week
  const data = await api('/api/approvals?_=' + Date.now());
  CURRENT_WEEK_START = data.week_start || '';
  const days = data.days || [];
  const start = days[0]?.ymd || data.week_start;
  const end = days[6]?.ymd || data.week_start;
  CURRENT_WEEK_RANGE = (start && end) ? `${start} to ${end}` : (data.week_start || '');
  el('payrollWeekLabel').textContent = CURRENT_WEEK_RANGE;
  el('reportWeekLabel').textContent = CURRENT_WEEK_RANGE;
  submittedCache = data.submitted;
  renderSubmitted(data.submitted, data.comments || []);
  buildWeekOptions(CURRENT_WEEK_START);
}

// Note: Clear test entries button removed ‚Äî use admin endpoints carefully via API.

// Dev controls hidden (sim tools disabled)
function setDevVisibility(visible) {
  const dev = el('devControls');
  if (!dev) return;
  dev.style.display = visible ? 'block' : 'none';
}
setDevVisibility(false);

// Week dropdowns removed; use current week from server

async function seedSampleWeeks(){
  const month = CURRENT_MONTH;
  if (!month) { alert('Missing current month'); return; }
  // Default to submitted+approved so seeded data is ready for exports/tests
  const submit = true;
  const approve = true;
  if (!confirm(`Seed entries for month ${month}?\nThis will create weekly entries for the entire month as SUBMITTED+APPROVED for admin review.`)) return;
  try {
    showPipelineResult(`Seeding month entries (SUBMITTED+APPROVED)...`);
    const result = await api('/api/admin/simulate-month', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ month, reset: false, submit, approve }) });
    const output = `‚úÖ Seeded month ${month}:\n${JSON.stringify(result, null, 2)}`;
    showPipelineResult(output);
  } catch (err) {
    showPipelineResult(`‚ùå Error: ${err.message}`);
  }
}

// Report download functions
async function downloadMonthly() {
  const month = CURRENT_MONTH;
  if (!month) { alert('Missing current month'); return; }
  window.location.href = `/api/export/monthly?month=${encodeURIComponent(month)}`;
}

function printWeekTimesheets() {
  const weekStart = el('weekSelect')?.value || CURRENT_WEEK_START;
  if (!weekStart) { alert('Select a week first'); return; }
  window.open(`/api/admin/print-week?week_start=${encodeURIComponent(weekStart)}`, '_blank');
}

function printWeekBilling() {
  const weekStart = el('weekSelect')?.value || CURRENT_WEEK_START;
  if (!weekStart) { alert('Select a week first'); return; }
  window.open(`/api/admin/print-week-billing?week_start=${encodeURIComponent(weekStart)}`, '_blank');
}

async function downloadBilling() {
  const month = CURRENT_MONTH;
  if (!month) { alert('Missing current month'); return; }
  window.location.href = `/api/export/monthly-billing?month=${encodeURIComponent(month)}`;
}

function fmtWeekLabel(ws) {
  if (!ws) return ws;
  const d = new Date(ws + 'T12:00:00Z');
  const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  return `Week of ${months[d.getUTCMonth()]} ${d.getUTCDate()}`;
}

async function previewReport() {
  const month = CURRENT_MONTH;
  if (!month) { alert('Missing current month'); return; }
  const preview = el('reportPreview');
  if (preview) {
    preview.style.display = 'block';
    preview.innerHTML = '<div style="color:#aaa;">Loading preview...</div>';
  }
  try {
    const result = await api(`/api/admin/report-preview?month=${encodeURIComponent(month)}`);
    const byWeek = result.byWeek || [];
    const commentRows = (result.comments || []).map(c => `<tr><td>${c.week_start}</td><td>${c.employee_name}</td><td>${c.comment || ''}</td></tr>`).join('');

    // === Weekly Summaries (expanded by default) ===
    let weeklyHtml = '';
    if (byWeek.length === 0) {
      weeklyHtml = '<p style="color:#aaa;">No approved entries for this month.</p>';
    }
    for (const wk of byWeek) {
      let custHtml = '';
      for (const c of wk.customers) {
        const empList = c.employees.map(e => `<span style="margin-right:10px;">${e.employee_name} <b>${Number(e.hours).toFixed(1)}h</b></span>`).join('');
        custHtml += `
          <div style="margin:6px 0; padding:6px 10px; background:rgba(255,255,255,0.05); border-radius:4px;">
            <div style="display:flex; justify-content:space-between; align-items:center;">
              <strong style="color:#f0c040;">${c.customer}</strong>
              <span style="color:#aaa;">${Number(c.hours).toFixed(1)}h &nbsp; $${Number(c.billed).toFixed(2)}</span>
            </div>
            <div style="margin-top:4px; font-size:0.85rem; color:#ccc;">${empList}</div>
          </div>`;
      }
      weeklyHtml += `
        <div style="margin-bottom:16px; border:1px solid rgba(255,255,255,0.1); border-radius:6px; padding:10px;">
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:6px;">
            <h3 style="margin:0; color:#5dade2;">üìÖ ${fmtWeekLabel(wk.weekStart)}</h3>
            <span style="font-size:0.9rem; color:#eee;"><b>${Number(wk.hours).toFixed(1)}h</b> &nbsp; <b>$${Number(wk.billed).toFixed(2)}</b></span>
          </div>
          ${custHtml}
        </div>`;
    }

    // === Monthly Summary (collapsed by default) ===
    const empRows = (result.employees || []).map(e => `<tr><td style="color:#ccc;">${e.employee_name}</td><td style="color:#eee;">${Number(e.hours).toFixed(2)}</td><td style="color:#eee;">$${Number(e.billed).toFixed(2)}</td></tr>`).join('');
    const monthlyHtml = `
      <details style="margin-top:16px; border:1px solid rgba(255,255,255,0.1); border-radius:6px; padding:8px;">
        <summary style="cursor:pointer; font-size:1rem; font-weight:bold; color:#5dade2; padding:4px;">
          üìã Monthly Summary ‚Äî ${result.totals.entries} entries, ${Number(result.totals.hours).toFixed(2)}h, $${Number(result.totals.billed).toFixed(2)}
        </summary>
        <div style="margin-top:10px;">
          <table style="width:100%;">
            <thead><tr><th style="text-align:left; color:#aaa;">Employee</th><th style="text-align:left; color:#aaa;">Hours</th><th style="text-align:left; color:#aaa;">Billed</th></tr></thead>
            <tbody>${empRows || '<tr><td colspan="3" style="color:#aaa;">No entries</td></tr>'}</tbody>
          </table>
        </div>
        ${commentRows ? `
          <div style="margin-top:10px;">
            <div style="color:#aaa; font-size:0.85rem;">Weekly comments</div>
            <table style="width:100%;">
              <thead><tr><th style="text-align:left; color:#aaa;">Week</th><th style="text-align:left; color:#aaa;">Employee</th><th style="text-align:left; color:#aaa;">Comment</th></tr></thead>
              <tbody>${commentRows}</tbody>
            </table>
          </div>
        ` : ''}
      </details>`;

    const html = `
      <div style="color:#aaa; font-size:0.85rem; margin-bottom:8px;">Payroll Report Preview ‚Äî ${result.month}</div>
      ${weeklyHtml}
      ${monthlyHtml}
    `;
    if (preview) preview.innerHTML = html;
  } catch (err) {
    if (preview) preview.innerHTML = `<div style="color:#e74c3c;">Error: ${err.message}</div>`;
  }
}

async function previewReconcile() {
  const month = el('closeMonth').value.trim();
  if (!month) { alert('Enter month to reconcile'); return; }
  
  try {
    showPipelineResult('Loading preview...');
    const result = await api('/api/admin/reconcile', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ month, confirm: false })
    });
    if (!result || result.entries === undefined) {
      showPipelineResult(`‚ö†Ô∏è No data to reconcile for ${month}.\nAll entries may already be archived.`);
      return;
    }
    const output = [
      `üìã Reconciliation Preview for ${month}`,
      ``,
      `Entries to archive: ${result.entries}`,
      `Total Hours: ${result.totalHours}`,
      `Total Billed: $${Number(result.totalBilled || 0).toFixed(2)}`,
      ``,
      result.entries > 0
        ? `Click "Reconcile & Clear" to archive and remove this data.`
        : `‚úÖ Nothing to reconcile ‚Äî all entries are already archived.`
    ].join('\n');
    showPipelineResult(output);
  } catch (err) {
    showPipelineResult(`‚ùå Error: ${err.message}`);
  }
}

async function closeMonth() {
  const month = el('closeMonth').value.trim();
  if (!month) { alert('Enter month to reconcile'); return; }
  
  const confirmed = confirm(`‚ö†Ô∏è This will archive and clear ALL time entries for ${month}.\n\nData will be saved to cloud storage but removed from active database.\n\nContinue?`);
  if (!confirmed) return;
  
  try {
    showPipelineResult('Archiving and clearing...');
    const result = await api('/api/admin/reconcile', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ month, confirm: true })
    });
    // Silent success - just clear the preview
    el('pipelineResult').style.display = 'none';
    if (el('reportPreview')) el('reportPreview').style.display = 'none';
  } catch (err) {
    showPipelineResult(`‚ùå Error: ${err.message}`);
  }
}

function showPipelineResult(text) {
  el('pipelineResult').style.display = 'block';
  el('pipelineOutput').textContent = text;
}

async function loadSubmitted(){
  const week_start = CURRENT_WEEK_START;
  await loadWeek(week_start);
}

function renderSubmitted(rows, comments){
  const commentRows = (comments || []).map(c => `<tr><td>${c.employee_name}</td><td>${c.comment || ''}</td><td>${c.week_start}</td></tr>`).join('');
  if (!rows.length){
    el('submitted').innerHTML = `
      <p class="muted">No submitted entries.</p>
      ${commentRows ? `
        <div style="margin-top:10px;">
          <div class="small muted">Weekly comments</div>
          <table>
            <thead><tr><th>Employee</th><th>Comment</th><th>Week</th></tr></thead>
            <tbody>${commentRows}</tbody>
          </table>
        </div>
      ` : ''}
    `;
    return;
  }
  const totalHours = rows.reduce((sum, r) => sum + Number(r.hours), 0);
  const html = `
    <table>
      <thead><tr>
        <th><input type="checkbox" id="selectAll" title="Select All" /></th>
        <th>Date</th><th>Employee</th><th>Customer</th><th>Hours</th>
        <th>Action</th>
      </tr></thead>
      <tbody>
        ${rows.map(r=>`
          <tr>
            <td><input type="checkbox" class="entry-cb" data-id="${r.id}" /></td>
            <td>${r.work_date}</td>
            <td>${r.employee_name}</td>
            <td>${r.customer_name}</td>
            <td>${Number(r.hours)}</td>
            <td><button class="delete-entry-btn badge" data-id="${r.id}" style="background:#e74c3c;color:white;padding:4px 8px;font-size:11px;">üóëÔ∏è</button></td>
          </tr>
        `).join('')}
      </tbody>
      <tfoot><tr style="font-weight:bold; background:#f0f0f0;">
        <td></td><td colspan="3">Total (${rows.length} entries)</td><td>${totalHours}</td><td></td>
      </tr></tfoot>
    </table>
    ${commentRows ? `
      <div style="margin-top:10px;">
        <div class="small muted">Weekly comments</div>
        <table>
          <thead><tr><th>Employee</th><th>Comment</th><th>Week</th></tr></thead>
          <tbody>${commentRows}</tbody>
        </table>
      </div>
    ` : ''}
  `;
  el('submitted').innerHTML = html;
  
  // Select All handler
  el('selectAll').onchange = function() {
    document.querySelectorAll('.entry-cb').forEach(cb => cb.checked = this.checked);
  };
  // Update Select All when individual boxes change
  document.querySelectorAll('.entry-cb').forEach(cb => {
    cb.onchange = updateSelectAllState;
  });

  // Attach delete button handlers
  document.querySelectorAll('.delete-entry-btn').forEach(btn => {
    btn.onclick = () => deleteEntry(btn.getAttribute('data-id'));
  });
}

function updateSelectAllState() {
  const all = document.querySelectorAll('.entry-cb');
  const checked = document.querySelectorAll('.entry-cb:checked');
  const selectAll = el('selectAll');
  if (selectAll) {
    selectAll.checked = all.length > 0 && all.length === checked.length;
    selectAll.indeterminate = checked.length > 0 && checked.length < all.length;
  }
}

async function approveSelected(){
  const ids = [...document.querySelectorAll('.entry-cb:checked')].map(x=>x.getAttribute('data-id'));
  if (!ids.length) { alert('Select at least one.'); return; }
  await api('/api/approve', {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ ids })
  });
  alert(`Approved ${ids.length} entries!`);
  await loadSubmitted();
}

// Delete entry handler
async function deleteEntry(id) {
  if (!confirm('Delete this entry? This cannot be undone.')) return;
  try {
    await api('/api/time-entries/' + id + '?force=true', { method: 'DELETE' });
    alert('Entry deleted!');
    await loadSubmitted();
    await loadAllEntries();
  } catch (e) {
    alert('Delete failed: ' + e.message);
  }
}

// Load all entries (not just submitted)
async function loadAllEntries() {
  const div = el('allEntries');
  const list = el('allEntriesList');
  div.style.display = 'block';
  list.innerHTML = '<p>Loading...</p>';
  
  try {
    const qs = CURRENT_WEEK_START ? ('?week_start=' + encodeURIComponent(CURRENT_WEEK_START)) : '';
    const data = await api('/api/admin/all-entries' + qs);
    const entries = data.entries || [];
    
    if (!entries.length) {
      list.innerHTML = '<p class="muted">No entries for this week.</p>';
      return;
    }
    
    // Group by employee
    const byEmp = {};
    for (const e of entries) {
      const name = e.employee_name || 'Unknown';
      if (!byEmp[name]) byEmp[name] = [];
      byEmp[name].push(e);
    }
    
    let html = '<table><thead><tr><th>Date</th><th>Employee</th><th>Customer</th><th>Hours</th><th>Status</th><th>Action</th></tr></thead><tbody>';
    for (const emp of Object.keys(byEmp).sort()) {
      for (const r of byEmp[emp]) {
        const statusColor = r.status === 'APPROVED' ? '#27ae60' : (r.status === 'SUBMITTED' ? '#f39c12' : '#95a5a6');
        html += `
          <tr>
            <td>${r.work_date}</td>
            <td>${r.employee_name}</td>
            <td>${r.customer_name}</td>
            <td>${Number(r.hours)}</td>
            <td><span style="background:${statusColor};color:white;padding:2px 6px;border-radius:3px;font-size:11px;">${r.status}</span></td>
            <td><button class="delete-entry-btn badge" data-id="${r.id}" style="background:#e74c3c;color:white;padding:4px 8px;font-size:11px;">üóëÔ∏è</button></td>
          </tr>`;
      }
    }
    html += '</tbody></table>';
    list.innerHTML = html;
    
    // Attach delete handlers
    document.querySelectorAll('#allEntriesList .delete-entry-btn').forEach(btn => {
      btn.onclick = () => deleteEntry(btn.getAttribute('data-id'));
    });
  } catch (err) {
    list.innerHTML = '<p style="color:red;">Error: ' + err.message + '</p>';
  }
}

init().catch(e=>{
  console.error(e);
  alert(e.message || 'Failed to load');
});
</script>
</body>
</html>


