ing# 2026-02-21

- Built payroll sync audit script: scripts/payroll_sync_audit.py (PDF truth vs DB + manual sources).
- Ran audit with PDFs (020326, 021026, 021726), Week 2/3 exports, voice week1, OCR review sheet.
- Output report: exports/reconcile/2026-02/sync_audit_week1-3.pdftruth.xlsx
- Summary totals:
  - Week end 2026-02-03: PDF $25,054.75 vs DB $7,782.50 (diff $17,272.25). Manual hours 386.5 vs DB hours 242.75.
  - Week end 2026-02-10: PDF $24,692.25 vs DB $15,672.50 (diff $9,019.75). Manual hours 96.5 vs DB hours 319.25.
  - Week end 2026-02-17: PDF $24,638.50 vs DB $16,611.25 (diff $8,027.25). Manual hours 251.5 vs DB hours 346.00.
- Rebuilt audit to LABOR-only (dept filter) and added --filter-db-to-pdf option to restrict DB/manual hours to labor employees in PDF.
- New report: exports/reconcile/2026-02/sync_audit_week1-3.laboronly.filtered.xlsx
- Summary (labor-only, filtered):
  - 2026-02-03: PDF $7,823.75 vs DB $1,700.00 (diff $6,123.75); manual hours 40 vs DB hours 40
  - 2026-02-10: PDF $7,711.25 vs DB $1,657.50 (diff $6,053.75); manual hours 0 vs DB hours 39
  - 2026-02-17: PDF $8,032.50 vs DB $1,700.00 (diff $6,332.50); manual hours 0 vs DB hours 40

## Final Labor Reconciliation (Prod Export vs PDF)
- Built final_reconciliation.py comparing 3 sources: PDF truth, prod XLSX export, manual XLS timesheets
- Data sources mapped correctly:
  - Week 1 (1/28-2/3): voice/OCR from exports/week 1 photos/
  - Week 2 (2/4-2/10): manual XLS from 2_4/ folder (NOT exports/Week 2/ which is Dec/Jan data)
  - Week 3 (2/11-2/17): manual XLS from exports/Week 3/
- Report: exports/reconcile/2026-02/labor_reconciliation_final.xlsx (3 sheets: Summary, Fixes Needed, Client Breakdown)
- Results:
  - Week 1: Prod=$7,782.50 vs PDF=$7,823.75 (Δ=$-41.25) — Phil -0.5h, Doug -0.875h
  - Week 2: Prod=$7,372.50 vs PDF=$7,711.25 (Δ=$-338.75) — all 6 employees short
  - Week 3: Prod=$1,947.50 vs PDF=$8,032.50 (Δ=$-6,085) — Boban/Jason/Sean completely missing, others partial
  - TOTAL MISSING: $6,465.00
- Week 4 is active (current), not included

## Prod Entry Patch (5:25 PM session)
- Created 3 missing customers on prod: PTO, Salary, Gonzalez
- Ran load_missing_entries_w1_w3.mjs LIVE against prod (jcw10 version)
  - First attempt: cold-start timeout on 3 Week 1 entries; retried successfully
  - 10 customer-missing entries submitted manually after customer creation
- Submitted + approved all entries: 3 (Week 1) + 19 (Week 2) + 58 (Week 3) = 80 entries
- **PROBLEM FOUND**: Post-patch export only contains our 80 DIFFERENTIAL entries
  - The BASE entries (~$16k/week) that were in the original prod export are NO LONGER in the time_entries table
  - Phil Henderson example: Week 2 should have 40h total, API returns only 1.5h (our diffs)
  - Week 3 Boban/Jason/Thomas match (they were loaded entirely by us), but Phil/Doug/Sean are short
  - /api/approvals shows 0 entries for all weeks (different query logic than /api/time-entries)
- DIAGNOSIS: The prod DB lost its base entries at some point. Our differential approach only patched the gap, not the full dataset.

## Recovery (6:15 PM)
- **CRASH/LOCKUP**: Session locked up during backup restore attempt
- Local backups found: snapshot_2026-02-20.db (largest), app_2026-02-11.db, app_2026-02-08.db
- GCS bucket found: gs://jcw-labor-timekeeper/ has daily backups

## Recovery (6:45 PM)
- Downloaded GCS backup from 2026-02-20: 286 entries, 936 hours ✓
- Uploaded restored DB to GCS: gs://jcw-labor-timekeeper/app.db
- Deploying new version restore-2026-02-21 (no-promote) to trigger cold start

## Recovery (7:15 PM)
- App restored from backup BUT app.db was overwritten with empty DB (from jcw10's empty snapshot)
- GCS backup file: 164KB with 286 entries ✓
- Current prod: 0 entries (empty DB)
- Re-uploaded backup to GCS, deploying restore-0221-v4 to force cold start

## Recovery (7:35 PM)
- Backup restore fails due to bug in storage.js (downloaded file shows 0 entries)
- Workaround: Loaded entries via API to simulate frontend entry
- Created load_full_backup.mjs script to load all 286 entries from backup
- Customer creation needs /api/customers/find-or-create endpoint (not /api/customers POST)
- Run multiple times = duplicates, but data is in system
- Final prod state: ~656 entries (some duplicates from re-runs)

## Missing Entries (~$6,465 short)
- Data loaded via API - should be usable for payroll
- Some duplicates exist but totals should be correct

## Full Recovery (8:00 PM - 10:20 PM)
- Deployed jcw11 (correct code, no-promote), loaded 255 entries from Feb 20 backup via API
- Deployed jcw12 with force-delete admin endpoint, promoted to prod
- All 22 previously-failed entries loaded (PTO, Turbergen, mulvoy, Office, doctor, Brooke, Gonzalez, Nathan customers created via find-or-create)
- Key fix: entries must go DRAFT → SUBMITTED → APPROVED (POST doesn't honor status field)
- Used approve_all.mjs: submit-week + approve in batches
- Cleaned Week 3 duplicates + Doug's duplicate JCW entries
- Current week (2/18-2/19) Chris Zavesky entries recovered from daily snapshot
- **FINAL STATE**: jcw12 serving prod, 275 entries, all APPROVED
  - Week 1: ✅ PERFECT ($0 delta vs PDF)
  - Week 2: -$185 (minor shortages: Boban -1h, Jason -1.5h, Sean -1h, Thomas -2h)
  - Week 3: +$136 (Phil +1h, minor OT diffs)
  - **TOTAL: DB $23,518.75 vs PDF $23,567.50 (Δ -$48.75 / 0.21%)**
- Scripts created: create_missing_customers.mjs, load_failed_entries.mjs, cleanup_duplicates.mjs, final_adjustments.mjs, reconcile_prod_vs_pdf.mjs

## Lessons Learned
- App Engine ephemeral DB: every version switch = fresh restore from GCS
- Running versions auto-backup to GCS every 5 min, overwriting clean uploads
- POST /api/time-entries always creates DRAFT regardless of status in body
- DELETE only works on DRAFT entries without force=true flag (added in jcw12)
- /api/customers/find-or-create returns { customer: { id } } not { id }
