# 2026-02-25 — Payroll Reconciliation & VM Migration

## Summary
Major payroll reconciliation session. Production data was restored from daily snapshot after App Engine ephemeral DB issues. Missing entries were added for Jason Green, Thomas Brinson, and Chris Zavesky. Chris Z's 12.5h lunch bug was fixed.

## Key Events

### Production Data Restored
- App Engine `/tmp/app.db` kept getting wiped on restarts
- Restored from GCS daily snapshot `app.db.2026-02-25` (184KB, 346 entries)
- After fixes: 366 entries total

### Payroll Fixes Applied (Week of Feb 18)
- **Chris Zavesky:** Added Mon 23 (Ueltschi 4h, Null 1h, Watkins 3h) + Tue 24 (Landy 2.5h, Ueltschi 5h, Watkins 3h). Fixed 12.5h lunch bug → 0.5h.
- **Jason Green:** Added ALL entries (Boyle 8h Wed, Boyle 4.5h+O'Connor 1.5h Thu, Richer 1.5h+Boyle 6.5h Fri, Boyle 8h Mon, Nathan 9h Tue). Total 39h.
- **Thomas Brinson:** Added most entries (Boyle+Landy Wed, Gonzalez Thu, Boyle Fri, Boyle+Landy Mon, Gonzalez Tue). Total ~39.5h.

### Manual Reconciliation Comparison
Manual payroll shows: Doug 46.25h, Phil 45h, Sean 44.25h, Thomas 41h, Jason salary, Chris Z salary.
System matches within ~1h for all hourly employees.

### VM Migration Status
- VM (`clawbot-ops`) is set up with the app running
- ngrok tunnel was established (`https://cf50-34-31-213-200.ngrok-free.app`)
- Proxy was deployed but reverted to keep App Engine running for payroll
- **Next:** Complete VM migration after payroll is finalized

### Report Issues (TODO)
- Weekly report format needs to match template (see Boban Abbate example)
- Chris Jacobi needs to be flagged as admin (same as Chris Z)
- OT calculation needs to appear on individual timesheets
- All reports need proper print headers
- Auto-backup race condition: deploys can overwrite GCS backup with empty DB

## Files Created
- `scripts/apply_payroll_fixes.py` — Script to add missing entries via API
- `labor-timekeeper/reconcile_feb18.cjs` — Reconciliation script (DB vs Excel)
- `labor-timekeeper/inspect_snapshot_feb25.cjs` — Snapshot inspection
- `docs/labor_timekeeper_vm_migration.md` — VM migration plan
- `labor-timekeeper/docker-compose.prod.yml` — Production docker config
- `labor-timekeeper/proxy_server.js` — App Engine proxy for VM
- `labor-timekeeper/app_proxy.yaml` — Proxy deployment config

---

## Session 2: VM Migration Execution (3:30 PM)

### What Was Done
1. **Pulled latest code** to VM (`clawbot-ops`, us-central1-a)
2. **Downloaded production DB** from GCS → `data/prod/app.db` (192KB, 390 entries, 95 customers, 8 employees)
3. **Created `.env.prod`** with production settings (NODE_ENV, PORT=8080, DATABASE_PATH, GCS config)
4. **Created systemd service** (`labor-timekeeper.service`) — auto-restarts, runs as nathan
5. **Fixed SQLITE_BUSY crash**: Server was re-downloading DB from GCS on every startup, conflicting with itself. Added `verifyDbEntries()` check — if local DB has data, skip cloud restore. Backward-compatible (App Engine always has empty /tmp).
6. **Service running**: `curl localhost:8080/api/health` → ✅ OK
7. **Secrets loading**: SMTP_USER, SMTP_PASS, OPENAI_API_KEY all loaded from Secret Manager

### Blockers (Need Nate Approval)
- **Firewall rule**: Port 8080 not exposed. Can't modify per .clinerules. Options documented in `docs/labor_timekeeper_vm_migration.md`
- **GCS write permissions**: `clawbot-sa` SA needs `storage.objectAdmin` for backups to work
- **App Engine proxy**: Once networking is solved, update `proxy_server.js` TARGET_URL and deploy

### Files Created/Modified
- `labor-timekeeper/server.js` — Added persistent storage skip logic
- `labor-timekeeper/.env.prod` — VM production environment config
- `labor-timekeeper/labor-timekeeper.service` — Systemd unit file
- `docs/labor_timekeeper_vm_migration.md` — Updated with actual status
